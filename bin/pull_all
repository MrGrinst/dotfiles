#!/bin/bash

configFile="$1"

get_latest() {
  echo "Pulling latest master for $1..."
  git latest
  echo -e "\n-------------------------------------------------\n"
}

if [[ -f "$configFile" ]]
then
  echo
  lines=($(cat "$configFile"))
  all_projects=()
  stashed_projects=()
  for line in "${lines[@]}"
  do
    project=$(echo $line | cut -d',' -f1)
    all_projects[${#all_projects[@]}]="$project"
  done
  unique_projects=$(IFS=$'\n' sort -u <<< "${all_projects[*]}")
  for project in $unique_projects
  do
    cd "$INSTRUCTURE_PATH/$project"
    if [[ -z $(git status -s) ]]; then
      if [[ -n $(git log origin/master..master) ]]; then
        echo -e "\nFor $project, this is checked out:"
        git log origin/master..master --oneline
        echo -en "\nWould you like to pull latest master? (y/n) "
        read input
        echo
        if [[ "$input" == "y" ]]; then
          get_latest $project
        else
          echo -e "\n-------------------------------------------------\n"
        fi
      else
        get_latest $project
      fi
    else
      stashed_projects[${#stashed_projects[@]}]="$project"
    fi
  done
  echo -e "Finished pulling all projects.\nThe following projects had stashed changes and couldn't be pulled:"
  ( IFS=$'\n'; echo "${stashed_projects[*]}" )
fi

